#!/bin/bash
###############################################################################
##### SYSTEM UPDATE                                                     #######
###############################################################################
update() {
    echo '-------------------------'
    echo '-------- UPDATE ---------'
    echo '-------------------------'
    if [[ $(lsb_release -is) == "Debian" || $(lsb_release -is) == "Ubuntu" ]]; then
        sudo apt update && sudo apt upgrade
    elif [[ $(lsb_release -is) == "Fedora" ]]; then
        sudo dnf update --refresh
    fi
    echo ''

    echo '-------------------------'
    echo '-------- FLATPAK --------'
    echo '-------------------------'
    flatpak update -y
    echo ''

    __update-rust
    __update-neovim
}

###############################################################################
##### UPDATE MAJOR TOOLS                                                #######
###############################################################################
__update-rust() {
    echo '-------------------------'
    echo '---------- RUST ---------'
    echo '-------------------------'
    rustup update
    cargo binstall --no-confirm \
        zoxide bat eza fd-find ripgrep sd procs fnm
    echo ''
}

__update-neovim() {
    echo '-------------------------'
    echo '-------- NEOVIM ---------'
    echo '-------------------------'
    local local_nvim_version=$(nvim --version | head -n1 | cut -d ' ' -f 2)
    local latest_nvim_version=$(curl -sL https://api.github.com/repos/neovim/neovim/releases/latest | jq -r '.tag_name')
    if [[ "$local_nvim_version" == "$latest_nvim_version" ]]; then
        echo 'Already up to date.'
        echo ''
    else
        curl -LO https://github.com/neovim/neovim/releases/latest/download/nvim-linux64.tar.gz
        rm -rf ~/Software/nvim-linux64
        tar -C ~/Software -xzf nvim-linux64.tar.gz
        rm nvim-linux64.tar.gz
    fi
    echo ''
}

__update-fzf() {
    git -C ~/Software/fzf pull
    ~/Software/fzf/install --bin
}

###############################################################################
####### BACKUP                                                           ######
###############################################################################
tar-pack() {
    local filename=$(basename "$1")
    tar --zstd -cvf "${filename}.tar.zst" "$1"
}

tar-unpack() {
    tar --zstd -xvf "$1"
}

backup-files() {
    cd ~ || exit
    # List of directories and files to back up
    local items=(
        ".config/BraveSoftware"
        ".dotfiles"
        "Private"
        "Work"
        "Projects"
        ".ssh"
        ".gitconfig"
    )

    for item in "${items[@]}"; do
        if [[ -e "$item" ]]; then
            tar-pack "$item"
        else
            echo "Skipping $item: does not exist."
        fi
    done
}
